import type { Section } from '../modules';
import type { GlossaryEntry } from '../glossary';
import type { PropertyEntry } from '../properties';

export const sections: Section[] = [
  {
    id: 'intro',
    number: '1',
    title: { zh: '简介', en: 'Introduction' },
    summary: { zh: 'CSS 通过属性来控制文档的渲染。每个属性有名称、值域和行为定义。', en: 'CSS controls document rendering through properties. Each property has a name, value domain, and behavior definition.' },
    keyPoints: [
      'CSS 属性定义了元素的视觉表现',
      '层叠机制解决多个规则冲突的问题',
      '继承机制让某些属性值从父元素传递到子元素',
      '每个属性有名称、值域(value space)和对渲染行为的定义',
      '层叠和默认处理以一组声明为输入,为每个元素的每个属性输出一个指定值(specified value)',
      '本模块替换并扩展了 CSS2 第 6 章关于属性值赋值、层叠和继承的规则',
      '文本节点被视为其关联元素的子元素,拥有完整的属性集;但由于无法被选择器匹配,其计算值全部由默认处理(defaulting)决定',
      '未连接到文档树或不在扁平树(flat tree)中的元素不参与 CSS 值处理,没有任何阶段的值',
      '属性通过属性声明(property declaration)赋值,将值(如 red、12pt)分配给对应元素或盒子',
    ],
  },
  {
    id: 'at-import',
    number: '2',
    title: { zh: '导入样式表', en: '@import' },
    summary: { zh: '@import 规则允许从其他样式表导入规则。导入的样式表被视为在 @import 位置展开。', en: 'The @import rule allows importing rules from other stylesheets. Imported stylesheets are treated as expanded at the @import position.' },
    keyPoints: [
      '@import 必须在样式表最前面(除了 @charset),否则无效',
      '可以添加媒体查询条件,指定在特定媒体类型下才应用导入的样式',
      '支持 supports() 条件判断,UA 可在条件不匹配时跳过加载资源',
      '导入的样式表的层叠来源与导入它的样式表相同',
      '同一样式表在多处导入时,UA 必须将每次链接视为独立样式表进行处理(但可缓存资源)',
      '@import 支持 url() 和裸字符串两种语法,效果完全等价',
      '导入条件(import conditions)不匹配时,等效于将导入的样式表包裹在对应的 @media/@supports 块中',
      'CSS Cascade 5 新增 layer 关键字,可将导入的样式表分配到指定层叠层(cascade layer)',
      '导入的样式表的编码环境(environment encoding)继承自导入它的样式表',
      '资源的 Content-Type 必须为 text/css 才会被解析为样式表,否则视为网络错误',
    ],
  },
  {
    id: 'shorthand',
    number: '3',
    title: { zh: '简写属性', en: 'Shorthand Properties' },
    summary: { zh: '简写属性允许同时设置多个相关属性的值。未指定的子属性会被重置为初始值。', en: 'Shorthand properties allow setting multiple related property values simultaneously. Unspecified sub-properties are reset to initial values.' },
    keyPoints: [
      '简写属性会重置所有子属性,未指定的子属性被设为初始值',
      'all 属性可以重置几乎所有 CSS 属性(direction 和 unicode-bidi 除外),但不影响自定义属性',
      '使用简写时要注意意外重置:如 background: green 会重置 background-image 为 none',
      '简写属性设为 CSS 全局关键字(initial/inherit/unset/revert)时,所有子属性都设为该关键字',
      '声明简写属性为 !important 等价于声明其所有子属性为 !important',
      '某些子属性是"仅重置子属性"(reset-only sub-property):被简写重置为初始值,但简写无语法设置其他值,如 border 会重置 border-image',
      '属性别名(aliasing)分为两种:legacy name alias(解析时名称转换)和 legacy shorthand(作为简写映射)',
      '简写属性有时有特殊语法或关键字,不直接对应子属性值,此时简写会显式定义展开方式',
      'all 属性仅接受 CSS 全局关键字;设为 initial 时会阻断所有继承并重置所有属性',
    ],
  },
  {
    id: 'value-stages',
    number: '4',
    title: { zh: '值的处理', en: 'Value Processing' },
    summary: { zh: '从声明值到实际值的完整流程:declared → cascaded → specified → computed → used → actual', en: 'The complete process from declared value to actual value: declared → cascaded → specified → computed → used → actual' },
    keyPoints: [
      'Declared Value(声明值): 所有适用于某元素某属性的声明值的集合,可能有零个或多个',
      'Cascaded Value(层叠值): 层叠排序后胜出的那个声明值,每个属性最多一个层叠值',
      'Specified Value(指定值): 层叠值经过默认处理后的值;每个元素的每个属性恰好有一个指定值',
      'Computed Value(计算值): 将指定值中的相对值(em、百分比、URL 等)尽可能解析为绝对值,不依赖布局;这是继承时传递的值',
      'Used Value(使用值): 将计算值完成所有剩余计算(如百分比宽度需要包含块尺寸)后的绝对理论值;不适用的属性没有使用值',
      'Actual Value(实际值): 使用值经过环境限制(可用字体、整数像素宽度等)调整后的最终渲染值',
      'getComputedStyle() 由于历史原因有时返回使用值而非计算值(如 width 返回像素值)',
      '某些属性的值有 legacy value alias(历史值别名):解析时旧语法自动转换为新语法,产生不同的声明值',
      '属性即使不适用于某元素,其计算值仍然存在,且可继承给后代生效(如对不适用元素设置 text-transform 仍会继承到内联子元素)',
      '"适用于所有元素"的属性适用于所有元素和显示类型,但不一定适用于所有伪元素(::before/::after 除外)',
    ],
  },
  {
    id: 'filtering',
    number: '5',
    title: { zh: '过滤', en: 'Filtering' },
    summary: { zh: '确定哪些声明适用于哪些元素。声明必须来自适用的样式表、匹配的选择器、有效的语法。', en: 'Determines which declarations apply to which elements. Declarations must come from applicable stylesheets, matching selectors, and valid syntax.' },
    keyPoints: [
      '样式表必须当前适用于文档(如 <link> 的 media 属性匹配)',
      '条件规则(@media, @supports)的条件必须为真,否则其中的声明不适用',
      '声明所属的样式规则的选择器必须匹配该元素(需考虑作用域 scoping)',
      '声明语法必须有效:属性名为已知属性,且值匹配该属性的语法定义',
      '过滤后得到的适用声明值构成每个元素每个属性的声明值列表(declared values list)',
      '声明值列表是层叠(cascade)处理的输入,由层叠进行优先级排序',
      '不满足任何一条过滤条件的声明将被完全忽略,不参与后续层叠',
      '对于特定媒体类型不适用的样式表中的所有声明都会被过滤掉',
      '过滤阶段区分于层叠阶段:过滤决定"哪些声明适用",层叠决定"哪个声明胜出"',
    ],
  },
  {
    id: 'cascading',
    number: '6',
    title: { zh: '层叠', en: 'Cascading' },
    summary: { zh: '当多个声明作用于同一属性时,按来源、重要性、特异性、顺序决定最终值。', en: 'When multiple declarations affect the same property, the final value is determined by origin, importance, specificity, and order.' },
    keyPoints: [
      '层叠排序依据(按优先级递减):来源与重要性 → 封装上下文 → 元素附属样式 → 层叠层 → 特异性 → 出现顺序',
      '来源优先级:Transition > !important UA > !important User > !important Author > Animation > Author > User > UA',
      '封装上下文(encapsulation context):Shadow DOM 等嵌套上下文中,普通规则外层优先,!important 规则内层优先',
      '元素附属样式(如 style 属性)在同来源同重要性下优先于选择器匹配的规则',
      'CSS Cascade 5 新增层叠层(@layer):同来源同上下文内可显式分层;普通规则后声明的层优先,!important 规则先声明的层优先',
      '未分配到显式层的规则被加入隐式最终层(implicit final layer),优先级高于所有显式层',
      '特异性:(ID, Class, Type) 三元组比较;相同来源、重要性、层级的声明按特异性排序',
      '出现顺序:以上条件都相同时,后声明的优先;@import 的声明视为在导入位置展开',
      '!important 的设计目的是平衡作者与用户样式表的权力:用户 !important 可覆盖作者 !important',
      '表现性提示(presentational hints)如 HTML 的 bgcolor 属性,被转换为 CSS 规则进入 UA 来源或特殊的作者表现性提示来源',
    ],
  },
  {
    id: 'defaulting',
    number: '7',
    title: { zh: '默认值', en: 'Defaulting' },
    summary: { zh: '当层叠没有结果时,通过继承或初始值确定属性值。可以使用 initial、inherit、unset、revert 关键字。', en: 'When cascading yields no result, property values are determined through inheritance or initial values. Keywords initial, inherit, unset, and revert can be used.' },
    keyPoints: [
      'initial: 将属性的指定值设为其初始值(initial value),无论该属性是否可继承',
      'inherit: 强制继承父元素的计算值;根元素无父元素时使用初始值',
      'unset: 继承属性等效 inherit,非继承属性等效 initial;可擦除层叠中此前的所有声明',
      'revert: 回滚到上一个来源的值;在作者来源中使用时回滚到用户来源,在用户来源中回滚到 UA 来源',
      'revert-layer(CSS Cascade 5 新增): 回滚到当前层叠层之下的层,若无更低层则回滚到上一个来源',
      '每个属性有初始值(initial value),在属性定义表中指定;非继承属性在层叠无结果时使用初始值',
      '继承属性(inherited property)在层叠无结果时使用父元素的计算值;属性定义表标明是否可继承',
      '继承沿文档树进行,不被匿名盒(anonymous box)截断;Shadow DOM 中 slot 分配的元素从 slot 继承而非 light tree 父元素',
      '伪元素按其定义的虚拟标签序列(fictional tag sequence)进行继承',
      'CSS 全局关键字(initial/inherit/unset/revert/revert-layer)可用于任何 CSS 属性,不能与其他值组合使用',
    ],
  },
];

export const anchors: Record<string, string> = {
  'cascade': 'cascading',
  'specificity': 'cascading',
  'important-rules': 'cascading',
  'inheritance': 'defaulting',
  'initial-value': 'value-stages',
  'specified-value': 'value-stages',
  'computed-value': 'value-stages',
  'computed-values': 'value-stages',
  'actual-value': 'value-stages',
  'usedValue': 'value-stages',
  'used-value': 'value-stages',
  'at-import': 'at-import',
};

export const glossaryTerms: Record<string, GlossaryEntry> = {
  'cascading': {
    zh: '层叠',
    description: '当多条规则试图设置同一元素的同一属性时,层叠机制按来源、重要性、特异性和顺序决定最终值。',
    sectionRef: 'cascade#cascading',
    css2Url: 'https://www.w3.org/TR/CSS22/cascade.html#cascade',
    specUrl: 'https://www.w3.org/TR/css-cascade-4/#cascading',
  },
  'specificity': {
    zh: '特异性(优先级)',
    description: '选择器的权重三元组 (ID, Class, Type),用于在层叠中比较同一来源、同一重要性的声明的优先级。',
    sectionRef: 'cascade#cascading',
    css2Url: 'https://www.w3.org/TR/CSS22/cascade.html#specificity',
    specUrl: 'https://www.w3.org/TR/selectors-4/#specificity',
  },
  'inheritance': {
    zh: '继承',
    description: '某些 CSS 属性(如 color、font-size)会自动从父元素传递到子元素,无需显式声明。',
    sectionRef: 'cascade#defaulting',
    css2Url: 'https://www.w3.org/TR/CSS22/cascade.html#inheritance',
    specUrl: 'https://www.w3.org/TR/css-cascade-4/#inheriting',
  },
  'specified value': {
    zh: '指定值',
    description: '经过层叠和默认处理后确定的属性值。如果层叠有结果就用层叠值,否则用继承值或初始值。',
    sectionRef: 'cascade#value-stages',
  },
  'computed value': {
    zh: '计算值',
    description: '将指定值中的相对值(如 em、百分比)转换为绝对值的结果。计算值是继承时传递给子元素的值。',
    sectionRef: 'cascade#value-stages',
  },
  'used value': {
    zh: '使用值',
    description: '将计算值应用到布局后的最终值。例如 width: 50% 在包含块宽度 800px 时,使用值为 400px。',
    sectionRef: 'cascade#value-stages',
  },
  'shorthand property': {
    zh: '简写属性',
    description: '同时设置多个相关属性的简写形式,如 margin、background、border。注意简写会重置所有子属性。',
    sectionRef: 'cascade#shorthand',
  },
  'declared value': {
    zh: '声明值',
    description: '对某元素的某个属性,所有匹配该元素的声明中给出的值的集合。是层叠处理的输入。',
    sectionRef: 'cascade#value-stages',
    css2Url: 'https://www.w3.org/TR/CSS22/cascade.html#value-def-declared',
  },
  'cascaded value': {
    zh: '层叠值',
    description: '经过层叠排序后胜出的那个声明值。如果没有声明,则该属性没有层叠值。',
    sectionRef: 'cascade#value-stages',
    css2Url: 'https://www.w3.org/TR/CSS22/cascade.html#value-def-cascaded',
  },
  'actual value': {
    zh: '实际值',
    description: '使用值经过最终环境限制(如屏幕分辨率、可用字体)调整后的值。浏览器实际用于渲染的最终值。',
    sectionRef: 'cascade#value-stages',
    css2Url: 'https://www.w3.org/TR/CSS22/cascade.html#actual-value',
  },
  'cascade origin': {
    zh: '层叠来源',
    description: '声明的来源分类:User-Agent(浏览器默认)、User(用户样式)、Author(开发者样式)。不同来源有不同的优先级。',
    sectionRef: 'cascade#cascading',
    specUrl: 'https://www.w3.org/TR/css-cascade-4/#origin',
  },
  'author origin': {
    zh: '作者来源',
    description: '开发者编写的样式表的层叠来源,包括 <style> 标签、外部 CSS 文件和行内样式。',
    sectionRef: 'cascade#cascading',
  },
  'user origin': {
    zh: '用户来源',
    description: '用户通过浏览器设置自定义的样式表的层叠来源。优先级低于作者来源(非 !important 时)。',
    sectionRef: 'cascade#cascading',
  },
  'user-agent origin': {
    zh: '用户代理来源',
    description: '浏览器内置的默认样式表的层叠来源。优先级最低(非 !important 时),定义了元素的默认外观。',
    sectionRef: 'cascade#cascading',
  },
  'important': {
    zh: '重要声明',
    description: '用 !important 标记的声明。重要声明的层叠优先级顺序与普通声明相反:UA > User > Author。',
    sectionRef: 'cascade#cascading',
    css2Url: 'https://www.w3.org/TR/CSS22/cascade.html#important-rules',
  },
  'shorthand properties': {
    zh: '简写属性',
    description: '一次性设置多个相关子属性的属性,如 margin、background、font。简写会重置所有子属性,包括未显式指定的。',
    sectionRef: 'cascade#shorthand',
    css2Url: 'https://www.w3.org/TR/CSS22/about.html#shorthand',
  },
  'longhand sub-properties': {
    zh: '子属性',
    description: '简写属性展开后对应的各个独立属性。如 border 的子属性包括 border-width、border-style、border-color。',
    sectionRef: 'cascade#shorthand',
  },
  'cascade layer': {
    zh: '层叠层',
    description: 'CSS Cascade 5 引入的机制,允许作者在同一来源内将样式规则组织到不同层中,按层的声明顺序控制优先级,而无需依赖选择器特异性或源码顺序。',
    sectionRef: 'cascade#cascading',
    specUrl: 'https://www.w3.org/TR/css-cascade-5/#layering',
  },
  '@layer': {
    zh: '@layer 规则',
    description: '用于声明层叠层的 at 规则。支持块语法(包含样式规则)和语句语法(仅声明层名和顺序)。层名可嵌套,用点号分隔表示层级。',
    sectionRef: 'cascade#cascading',
    specUrl: 'https://www.w3.org/TR/css-cascade-5/#at-layer',
  },
  'revert-layer': {
    zh: 'revert-layer 关键字',
    description: 'CSS Cascade 5 新增的全局关键字,将属性值回滚到当前层叠层之下的层。若无更低优先级的层,则回滚到上一个来源。',
    sectionRef: 'cascade#defaulting',
    specUrl: 'https://www.w3.org/TR/css-cascade-5/#revert-layer',
  },
  'encapsulation context': {
    zh: '封装上下文',
    description: '文档语言提供的声明来源隔离机制,如 Shadow DOM 的树上下文(tree context)。层叠中普通规则外层上下文优先,!important 规则内层上下文优先。',
    sectionRef: 'cascade#cascading',
    specUrl: 'https://www.w3.org/TR/css-cascade-5/#cascade-context',
  },
  'shadow dom': {
    zh: 'Shadow DOM',
    description: 'Web Components 的封装机制,创建独立的 DOM 子树和样式作用域。在层叠中形成独立的封装上下文,继承沿扁平树(flat tree)而非 light tree 进行。',
    sectionRef: 'cascade#cascading',
  },
  'presentational hints': {
    zh: '表现性提示',
    description: '文档标记中的表现性属性(如 HTML 的 bgcolor、<s> 元素),被转换为等效 CSS 规则进入层叠。进入 UA 来源或特殊的作者表现性提示来源(位于用户来源与作者来源之间)。',
    sectionRef: 'cascade#cascading',
    css2Url: 'https://www.w3.org/TR/CSS22/cascade.html#preshint',
    specUrl: 'https://www.w3.org/TR/css-cascade-5/#preshint',
  },
  'initial value': {
    zh: '初始值',
    description: '每个属性在定义表中指定的默认值。非继承属性在层叠无结果时使用初始值作为指定值。',
    sectionRef: 'cascade#defaulting',
    css2Url: 'https://www.w3.org/TR/CSS22/cascade.html#specified-value',
    specUrl: 'https://www.w3.org/TR/css-cascade-5/#initial-values',
  },
  'inherited property': {
    zh: '继承属性',
    description: '属性定义表中标记为"inherited: yes"的属性。当层叠无结果时,自动使用父元素的计算值。典型例子:color、font-size、line-height。',
    sectionRef: 'cascade#defaulting',
    specUrl: 'https://www.w3.org/TR/css-cascade-5/#inheriting',
  },
  'css-wide keywords': {
    zh: 'CSS 全局关键字',
    description: '所有 CSS 属性都接受的关键字:initial(初始值)、inherit(继承)、unset(擦除)、revert(回滚来源)、revert-layer(回滚层)。不能与其他值组合。',
    sectionRef: 'cascade#defaulting',
    specUrl: 'https://www.w3.org/TR/css-values-4/#css-wide-keywords',
  },
  'reset-only sub-property': {
    zh: '仅重置子属性',
    description: '简写属性的一种特殊子属性:被简写重置为初始值,但简写语法无法将其设为其他值。如 border 会重置 border-image 为 none。',
    sectionRef: 'cascade#shorthand',
    specUrl: 'https://www.w3.org/TR/css-cascade-5/#shorthand',
  },
};

export const propertyTerms: Record<string, PropertyEntry> = {
  'all': {
    zh: '全部属性简写',
    value: 'initial | inherit | unset | revert | revert-layer',
    initial: '见各属性定义',
    appliesTo: '见各属性定义',
    inherited: false,
    percentages: null,
    computedValue: '见各属性定义',
    css2Url: 'https://www.w3.org/TR/css-cascade-4/#all-shorthand',
    css3Url: 'https://www.w3.org/TR/css-cascade-5/#all-shorthand',
    sectionRef: 'cascade#shorthand',
  },
};
